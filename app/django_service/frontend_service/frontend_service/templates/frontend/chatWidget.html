{% block chatWidget %}

    <!-- Trigger Button -->
   <!-- Offcanvas Bottom-Right -->
<div
        class="offcanvas offcanvas-bottom-right"
        id="offcanvasBottom"
        aria-labelledby="offcanvasBottomLabel"
        style="visibility: hidden; height: 0;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasBottomLabel">Chat</h5>
        <button
                type="button"
                class="btn-close text-reset"
                id="offcanvasClose"
                aria-label="Close">
        </button>
    </div>
    <div class="offcanvas-body">
        <!-- Chat Widget Content -->
        <div class="chat-container d-flex flex-row">
            <!-- Chat Room List -->
            <div class="chat-list me-4">
                <ul id="chatRoomList" class="list-unstyled">
                    <!-- The chat room list will be dynamically populated by JavaScript -->
                </ul>
            </div>

            <!-- Chat Details and Messages -->
            <div class="chat-details flex-fill">
                <!-- Header for chat room title or placeholder text -->
                <div class="chat-header bg-light p-2 text-center border rounded mb-2">
                    <strong>Select a Chat Room</strong>
                </div>

                <!-- Message Container -->
                <div class="chat-messages border p-3 rounded" id="chatMessages" style="height: 300px; overflow-y: auto;">
                    <div class="text-muted">No messages to show.</div>
                </div>

                <!-- Message Input and Send Button -->
                <div class="chat-input mt-3">
                    <textarea
                        id="messageInput"
                        class="form-control"
                        placeholder="Type a message..."
                        rows="3"
                        style="resize: none;"></textarea>
                    <button
                        id="sendMessageButton"
                        class="btn btn-primary btn-sm w-100 mt-2">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Button -->
<button
        class="btn btn-secondary"
        id="toggleOffcanvasButton">
    Open Chat
</button>

    <!-- Main Chat Widget Style -->
    <style>
        /* Offcanvas Bottom-Right Styling */
        .offcanvas-bottom-right {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 33vw;
            height: 0;
            max-height: 50vh;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.42);
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1050;
            overflow: hidden;
            transition: height 0.3s ease, visibility 0.3s ease;
        }

        .offcanvas-bottom-right.show {
            visibility: visible;
            height: 50vh;
            width: 33vw;
        }

        /* Overall layout */
        .chat-container {
            display: flex;
            height: 100%;
        }

        /* Chat Room List */
        .chat-list {
            width: 30%;
            background-color: rgba(245, 245, 245, 0.37);
            border-right: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
        }

        .chat-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-list li {
            margin: 10px 0;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .chat-list li:hover {
            background-color: #e0e0e0;
        }

        /* Chat Messages Section */
        .chat-details {
            width: 70%;
            padding: 15px;
        }

        .chat-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .chat-messages {
            height: calc(100% - 100px);
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(250, 250, 250, 0.46);
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            height: 70px;
            resize: none;
        }

        button {
            margin-top: 10px;
        }
    </style>

    <!-- Script for Chat Functionality -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.getElementById("toggleOffcanvasButton");
        const offcanvas = document.getElementById("offcanvasBottom");
        const closeButton = document.getElementById("offcanvasClose");
        const chatRoomList = document.getElementById("chatRoomList"); // UL for chat rooms
        const chatMessages = document.getElementById("chatMessages");
        const messageInput = document.getElementById("messageInput");
        const sendMessageButton = document.getElementById("sendMessageButton");

        let activeChatRoomId = null; // Track the active chat room ID
        const currentUserId = 112610; // Example user ID (replace with actual dynamic user data)

        // Toggle Offcanvas Visibility
        const updateOffcanvasVisibility = () => {
            const isVisible = offcanvas.classList.contains("show");
            if (isVisible) {
                // Hide the offcanvas
                offcanvas.classList.remove("show");
                offcanvas.style.visibility = "hidden";
                offcanvas.style.height = "0";
            } else {
                // Show the offcanvas
                offcanvas.classList.add("show");
                offcanvas.style.visibility = "visible";
                offcanvas.style.height = "50vh";
            }
        };

        toggleButton.addEventListener("click", updateOffcanvasVisibility);
        closeButton.addEventListener("click", updateOffcanvasVisibility);

        // Fetch Chat Room IDs
        async function fetchChatRoomIDs() {
            const query = `
                query getUserChatRoom {
                    chatRoomsForUser {
                        id
                    }
                }
            `;

            try {
                const response = await fetch("/graphql", { // Replace with your GraphQL endpoint
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                    body: JSON.stringify({ query }),
                });

                const result = await response.json();
                return result.data.chatRoomsForUser || []; // Return chat room IDs
            } catch (error) {
                console.error("Error fetching chat room IDs:", error);
                return [];
            }
        }

        // Dynamically Build Query for Chat Room Details
        function buildChatRoomDetailsQuery(chatRoomIDs) {
            const chatRoomQueries = chatRoomIDs
                .map(
                    (id, index) => `
                    chatRoom${index + 1}: chatRoom(id: ${id}) {
                        id
                        name
                        gameId
                        createdAt
                    }
                `
                )
                .join("\n");

            return `
                query GetChatRoomData {
                    ${chatRoomQueries}
                }
            `;
        }

        // Fetch Detailed Chat Room Data
        async function fetchDetailedChatRoomData(chatRoomIDs) {
            const detailedQuery = buildChatRoomDetailsQuery(chatRoomIDs);

            try {
                const response = await fetch("/graphql", { // Replace with your GraphQL endpoint
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                    body: JSON.stringify({ query: detailedQuery }),
                });

                const result = await response.json();
                const chatRooms = chatRoomIDs.map(
                    (id, index) => result.data[`chatRoom${index + 1}`]
                );
                return chatRooms;
            } catch (error) {
                console.error("Error fetching detailed chat room data:", error);
                return [];
            }
        }

        // Populate Chat Room List in UI
        function populateChatRoomList(chatRooms) {
            chatRoomList.innerHTML = ""; // Clear existing list

            chatRooms.forEach(chatRoom => {
                const listItem = document.createElement("li");
                listItem.className = "chat-room";
                listItem.dataset.chatRoomId = chatRoom.id;
                listItem.textContent = chatRoom.name;

                // Add click event to handle room selection
                listItem.addEventListener("click", function () {
                    setActiveChatRoom(chatRoom.id);
                });

                chatRoomList.appendChild(listItem);
            });
        }

        // Set Active Chat Room and Fetch Messages
        function setActiveChatRoom(chatRoomId) {
            activeChatRoomId = chatRoomId;
            document.querySelectorAll(".chat-room").forEach(room => room.classList.remove("active"));

            const selectedRoom = document.querySelector(
                `.chat-room[data-chat-room-id="${chatRoomId}"]`
            );
            if (selectedRoom) {
                selectedRoom.classList.add("active");
                fetchChatRoomMessages(chatRoomId);
            }
        }

        // Fetch Chat Messages for the Active Room
        function fetchChatRoomMessages(chatRoomId) {
            chatMessages.innerHTML = '<div class="text-muted">Loading...</div>';

            const query = `
                query FetchMessages {
                    chatRoom(id: ${chatRoomId}) {
                        id
                        messages {
                            id
                            content
                            senderId
                            timestamp
                        }
                    }
                }
            `;

            fetch("/graphql", { // Replace with your GraphQL endpoint
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                },
                body: JSON.stringify({ query }),
            })
                .then(response => response.json())
                .then(data => {
                    const messages = data.data.chatRoom.messages || [];
                    displayMessages(messages);
                })
                .catch(error => {
                    console.error("Error fetching chat messages:", error);
                    chatMessages.innerHTML =
                        '<div class="text-danger">Error loading messages. Please try again later.</div>';
                });
        }

        // Display Messages in the Messages Section
        function displayMessages(messages) {
            chatMessages.innerHTML = ""; // Clear old messages
            messages.forEach(message => {
                const senderName = message.senderId == currentUserId ? "You" : `User ${message.senderId}`;
                const messageElement = document.createElement("div");
                messageElement.className = "border-bottom pb-2 mb-2";
                messageElement.innerHTML = `<strong>${senderName}:</strong> ${message.content}`;
                chatMessages.appendChild(messageElement);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        // Send a New Message
        sendMessageButton.addEventListener("click", function () {
            const messageContent = messageInput.value.trim();

            if (messageContent && activeChatRoomId) {
                const mutation = `
                    mutation SendMessage {
                        createChatRoomMessage(
                            input: { chatRoomId: ${activeChatRoomId}, content: "${messageContent}" }
                        ) {
                            success
                            message
                        }
                    }
                `;

                fetch("/graphql", { // Replace with your GraphQL endpoint
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                    },
                    body: JSON.stringify({ query: mutation }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.data.createChatRoomMessage.success) {
                            // Append message to chat UI
                            const messageElement = document.createElement("div");
                            messageElement.className = "border-bottom pb-2 mb-2 text-end text-primary";
                            messageElement.innerHTML = `<strong>You:</strong> ${messageContent}`;
                            chatMessages.appendChild(messageElement);

                            messageInput.value = ""; // Clear input
                            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
                        } else {
                            alert("Failed to send the message. Please try again.");
                        }
                    })
                    .catch(error => {
                        console.error("Error sending message:", error);
                        alert("An error occurred. Please try again.");
                    });
            } else {
                alert("Please select a chat room and enter a message.");
            }
        });

        // Load Chat Rooms on Page Load
        async function loadChatRooms() {
            const chatRoomListData = await fetchChatRoomIDs();
            const chatRoomIDs = chatRoomListData.map(room => room.id);

            if (chatRoomIDs.length > 0) {
                const chatRooms = await fetchDetailedChatRoomData(chatRoomIDs);
                populateChatRoomList(chatRooms);
            } else {
                chatRoomList.innerHTML = '<li class="text-muted">No chat rooms available.</li>';
            }
        }

        // Initialize
        loadChatRooms();
    });
</script>

{% endblock chatWidget %}