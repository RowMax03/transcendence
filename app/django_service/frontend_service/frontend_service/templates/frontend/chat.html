{% extends "frontend/base.html" %}
{% block title %}Chats{% endblock %}

{% block content %}
    {% include "frontend/chatWidget.html" %}
      <!--
     <style>
        /* Overall layout */
        .chat-container {
            display: flex;          /* Enables horizontal layout */
            height: 100vh;          /* Takes full viewport height */
            margin: 0;              /* Removes default margin */
            padding: 0;             /* Removes default padding */
            box-sizing: border-box; /* Makes width and height behave predictably */
        }

        /* Left side: Chat room list */
        .chat-list {
            width: 25%;             /* 1/4 of the screen */
            background-color: rgba(245, 245, 245, 0.37);
            border-right: 1px solid #ccc; /* Right border for separation */
            overflow-y: auto;       /* Ensures scroll if content overflows */
            padding: 16px;
        }

        .chat-list ul {
            list-style-type: none;  /* Removes bullets from the list */
            padding: 0;
            margin: 0;
        }

        .chat-list li {
            margin: 8px 0;          /* Spacing between items */
            padding: 8px 12px;      /* Padding inside each item */
            cursor: pointer;        /* Pointer cursor on hover */
            border-radius: 4px;
            transition: background-color 0.2s ease; /* Smooth hover effect */
        }

        .chat-list li:hover {
            background-color: #e0e0e0; /* Highlighted background on hover */
        }

        /* Right side: Chat details */
        .chat-details {
            width: 75%;             /* 3/4 of the screen */
            padding: 16px;
        }

        .chat-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .chat-messages {
            height: calc(100vh - 32px); /* Adjust for consistent spacing */
            overflow-y: auto;           /* Add scrolling to messages */
            background-color: rgba(250, 250, 250, 0.46);
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 4px;
        }
        .collapsed {
    display: none !important;
}
        /* Style for the messages */
.chat-messages {
    color: #6c757d; /* Bootstrap's secondary gray */
    font-size: 0.9rem; /* Slightly smaller font size for a cleaner look */
}

/* Style for the placeholder text in the textarea */
textarea::placeholder {
    color: #adb5bd; /* A lighter gray for the placeholder */
}

/* Style for user-inputted text in the textarea */
textarea {
    color: #6c757d !important; /* Bootstrap secondary gray for text */
    background-color: #f8f9fa !important; /* Light gray background */
}
    </style>
  <section class="section" style="padding: 10vw">
<div id="chatWidget"  data-current-user-id="{{ user.id }}" class="card position-fixed shadow-lg collapsed" style="bottom: 20px; right: 20px; width: 350px; z-index: 1050;">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <span>Chat Widget</span>
        <button id="chatToggleClose" class="btn-close btn-close-white"></button>
    </div>

    <div class="card-body p-2">
        <div class="mb-3">
            <div class="list-group" id="chatRoomList" style="max-height: 120px; overflow-y: auto;">
                {% for chatRoom in chatRooms %}
                    <button class="list-group-item list-group-item-action" data-chat-room-id="{{ chatRoom.id }}">{{ chatRoom.name }}</button>
                {% empty %}
                    <div class="list-group-item text-muted">No chat rooms available.</div>
                {% endfor %}
            </div>
        </div>

        <div class="chat-messages border rounded p-2 mb-3" id="chatMessages" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
            <div class="text-muted">No messages to show.</div>
        </div>

        <div>
            <textarea id="messageInput" class="form-control" placeholder="Type a message..." rows="3"></textarea>
            <button id="sendMessageButton" class="btn btn-primary btn-sm w-100 mt-2">Send</button>
        </div>
    </div>
</div>

<button id="chatToggleOpen" class="btn btn-primary position-fixed rounded-circle shadow-lg" style="bottom: 20px; right: 20px; width: 50px; height: 50px; z-index: 1049; display: inline-flex; justify-content: center; align-items: center;">
    <i class="bi bi-chat-dots"></i>
</button>
  </section>-->
{% endblock content %}
{% block extra_js %}
<!--
    <script>
   document.addEventListener('DOMContentLoaded', function () {
    const chatWidget = document.getElementById('chatWidget');
    const chatToggleOpen = document.getElementById('chatToggleOpen');
    const chatToggleClose = document.getElementById('chatToggleClose');
    const chatRoomList = document.getElementById('chatRoomList');
    const chatHeader = document.querySelector('.card-header span');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageButton = document.getElementById('sendMessageButton');

    let activeChatRoomId = null; // Track the active chat room ID
    const currentUserId = 112610;

    // Open chat widget
    chatToggleOpen.addEventListener('click', function () {
        chatWidget.classList.remove('collapsed');
        chatToggleOpen.style.display = 'none';
    });

    // Close chat widget
    chatToggleClose.addEventListener('click', function () {
        chatWidget.classList.add('collapsed');
        chatToggleOpen.style.display = 'flex';
    });

    // Handle chat room selection
    chatRoomList.addEventListener('click', function (event) {
        const selectedRoom = event.target;

        // Remove 'active' class from all chat room buttons
        document.querySelectorAll('#chatRoomList .list-group-item').forEach(item => {
            item.classList.remove('active');
        });

        // Mark the selected room as active
        selectedRoom.classList.add('active');

        // Get the chat room ID from the selected room
        activeChatRoomId = selectedRoom.getAttribute('data-chat-room-id');

        if (activeChatRoomId) {
            // Update chat header with the name of the selected room
            chatHeader.textContent = selectedRoom.textContent;

            // Fetch messages for the selected chat room
            fetchChatRoomMessages(activeChatRoomId);
        }
    });

    // Fetch chat room messages
    function fetchChatRoomMessages(chatRoomId) {
        // Show a loading message
        chatMessages.innerHTML = '<div class="text-muted">Loading...</div>';

        const graphqlQuery = {
            query: `
                query ChatRoomQuery {
                    chatRoom(id: ${chatRoomId}) {
                        id
                        name
                        createdAt
                        messages {
                            id
                            chatRoomId
                            content
                            senderId
                            timestamp
                        }
                    }
                }
            `,
        };

        fetch('http://localhost:8001/graphql/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify(graphqlQuery),
        })
            .then(response => response.json())
            .then(data => {
                const chatRoom = data.data.chatRoom;

                if (chatRoom && chatRoom.messages && chatRoom.messages.length > 0) {
                    chatMessages.innerHTML = ''; // Clear existing messages
                    chatRoom.messages.forEach(message => {
                        const senderName = message.senderId == currentUserId ? 'You' : message.senderId; // Replace senderId with "You" if it matches currentUserId
                        const messageElement = document.createElement('div');
                        messageElement.className = 'border-bottom pb-2 mb-2';
                        messageElement.innerHTML = `<strong>${senderName}:</strong> ${message.content}`;
                        chatMessages.appendChild(messageElement);
                    });
                } else {
                    chatMessages.innerHTML = '<div class="text-muted">No messages to show.</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching chat messages:', error);
                chatMessages.innerHTML = '<div class="text-danger">Failed to load messages.</div>';
            });
    }

    // Handle sending a message
    sendMessageButton.addEventListener('click', function () {
        const message = messageInput.value.trim();

        // Validate that a message is entered and a chat room is selected
        if (message && activeChatRoomId) {
            const graphqlMutation = {
                query: `
                    mutation SendMessage {
                        createChatRoomMessage(input: {chatRoomId: ${activeChatRoomId}, content: "${message}"}) {
                            success
                            message
                        }
                    }
                `,
            };

            fetch('http://localhost:8001/graphql/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(graphqlMutation),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.data.createChatRoomMessage.success) {
                        // Successfully sent message, append it to the chat view
                        const messageElement = document.createElement('div');
                        messageElement.className = 'border-bottom pb-2 mb-2 text-end text-primary';
                        messageElement.innerHTML = `<strong>You:</strong> ${message}`;
                        chatMessages.appendChild(messageElement);

                        // Scroll to the bottom of the chat
                        chatMessages.scrollTop = chatMessages.scrollHeight;

                        // Clear the text input field
                        messageInput.value = '';
                    } else {
                        console.error('Failed to send message:', data.data.createChatRoomMessage.message);
                        alert('Failed to send the message. Please try again!');
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    alert('An error occurred while sending the message.');
                });
        } else {
            alert('Please select a chat room and enter a message!');
        }
    });
});
</script> -->
{% endblock extra_js %}