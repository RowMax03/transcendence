{% extends "frontend/base.html" %}
{% block title %}Chats{% endblock %}

{% block content %}
     <style>
        /* Overall layout */
        .chat-container {
            display: flex;          /* Enables horizontal layout */
            height: 100vh;          /* Takes full viewport height */
            margin: 0;              /* Removes default margin */
            padding: 0;             /* Removes default padding */
            box-sizing: border-box; /* Makes width and height behave predictably */
        }

        /* Left side: Chat room list */
        .chat-list {
            width: 25%;             /* 1/4 of the screen */
            background-color: rgba(245, 245, 245, 0.37);
            border-right: 1px solid #ccc; /* Right border for separation */
            overflow-y: auto;       /* Ensures scroll if content overflows */
            padding: 16px;
        }

        .chat-list ul {
            list-style-type: none;  /* Removes bullets from the list */
            padding: 0;
            margin: 0;
        }

        .chat-list li {
            margin: 8px 0;          /* Spacing between items */
            padding: 8px 12px;      /* Padding inside each item */
            cursor: pointer;        /* Pointer cursor on hover */
            border-radius: 4px;
            transition: background-color 0.2s ease; /* Smooth hover effect */
        }

        .chat-list li:hover {
            background-color: #e0e0e0; /* Highlighted background on hover */
        }

        /* Right side: Chat details */
        .chat-details {
            width: 75%;             /* 3/4 of the screen */
            padding: 16px;
        }

        .chat-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .chat-messages {
            height: calc(100vh - 32px); /* Adjust for consistent spacing */
            overflow-y: auto;           /* Add scrolling to messages */
            background-color: rgba(250, 250, 250, 0.46);
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 4px;
        }
    </style>
  <section class="section" style="padding: 10vw">
     <div class="chat-container">
        <!-- Left Section: Chat Room List -->
        <div class="chat-list">
            <ul id="chatRoomList">
                {% for chatRoom in chatRooms %}
                    <li data-chat-room-id="{{ chatRoom.id }}">{{ chatRoom.name }}</li>
                {% empty %}
                    <li>No chat rooms available.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Right Section: Chat Details -->
        <div class="chat-details">
            <div class="chat-header" id="chatHeader">Select a chat room to view messages</div>
            <div class="chat-messages" id="chatMessages">
                <div class="no-messages">No messages to show.</div>
            </div>
        </div>
    </div>
  </section>
{% endblock content %}
{% block extra_js %}
<script>
        document.addEventListener('DOMContentLoaded', function () {
            const chatRoomList = document.getElementById('chatRoomList');
            const chatHeader = document.getElementById('chatHeader');
            const chatMessages = document.getElementById('chatMessages');

            // Add click event listener to each chat room item
            chatRoomList.addEventListener('click', function (event) {
                const clickedItem = event.target;
                const chatRoomId = clickedItem.getAttribute('data-chat-room-id');

                if (chatRoomId) {
                    // Fetch messages for this chat room
                    fetchChatRoomMessages(chatRoomId);
                }
            });

function fetchChatRoomMessages(chatRoomId) {
    // Update the chat header to indicate loading
    chatHeader.textContent = 'Loading...';

    // Clear existing messages
    chatMessages.innerHTML = '';

    // Define the GraphQL query
    const graphqlQuery = {
        query: `
        query ChatRoomQuery {
          chatRoom(id: ` +  chatRoomId +  `) {
            id
            name
            createdAt
            messages {
              id
              chatRoomId
              content
              senderId
              timestamp
            }
          }
        }
        `,
    };

    // Make an HTTP POST request to the GraphQL API endpoint
    fetch('http://localhost:8001/graphql/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify(graphqlQuery), // Send the GraphQL query as the request body
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Extract chat room details from the GraphQL response
            const chatRoom = data.data.chatRoom;

            if (!chatRoom) {
                throw new Error('Chat room not found in the response.');
            }

            // Update header with the name of the chat room
            chatHeader.textContent = chatRoom.name;

            // Populate messages in the chatMessages container
            if (chatRoom.messages && chatRoom.messages.length > 0) {
                chatRoom.messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message';
                    messageElement.textContent = `${message.senderId}: ${message.content}`;
                    chatMessages.appendChild(messageElement);
                });
            } else {
                // Show a "no messages" placeholder if messages are empty
                const noMessagesElement = document.createElement('div');
                noMessagesElement.className = 'no-messages';
                noMessagesElement.textContent = 'No messages to show.';
                chatMessages.appendChild(noMessagesElement);
            }
        })
        .catch(error => {
            console.error('Error fetching chat room:', error);
            chatHeader.textContent = 'Error loading chat.';
            chatMessages.innerHTML = `
                <div class="no-messages">Failed to load messages. Try again later.</div>
            `;
        });
}
        });
</script>
{% endblock extra_js %}